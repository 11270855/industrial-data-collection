# 连接错误修复说明

**修复日期**：2025-12-11  
**修复版本**：1.1

---

## 问题描述

系统运行时出现以下问题：
1. OPC UA连接出错
2. 数据库连接出错后形成无限循环
3. 错误信息没有正确显示

---

## 修复内容

### 1. 数据库连接修复 (database.py)

#### 问题1：SQL语句执行错误

**原因**：SQLAlchemy 2.0 版本中，原始SQL语句需要使用`text()`函数包装

**修复前**：
```python
conn.execute("SELECT 1")
```

**修复后**：
```python
from sqlalchemy import text
conn.execute(text("SELECT 1"))
```

#### 问题2：重连逻辑可能导致无限循环

**原因**：`execute_with_retry`方法中的重连逻辑没有限制重试次数

**修复内容**：
- 在重连时限制重试次数为1次
- 添加了`last_error`变量确保错误被正确抛出
- 在`reconnect`方法中添加了异常处理

---

### 2. OPC UA客户端修复 (opcua_client.py)

#### 问题1：安全策略设置失败未处理

**修复内容**：添加了安全策略设置的异常处理
```python
try:
    self.client.set_security_string("None")
except Exception as sec_e:
    logger.warning(f"设置安全策略失败（可能不支持）: {sec_e}")
```

#### 问题2：连接失败后未清理资源

**修复内容**：连接失败后清理client对象
```python
if self.client:
    try:
        self.client.disconnect()
    except:
        pass
    self.client = None
```

#### 问题3：指数退避等待时间过长

**修复内容**：限制最大等待时间为30秒
```python
wait_time = min(self.retry_delay * (2 ** (retry_count - 1)), 30)
```

---

### 3. 主程序修复 (main.py)

#### 问题1：连接失败后无限重试

**修复内容**：添加了重连失败计数器
- OPC UA重连失败计数器
- 数据库重连失败计数器
- 最大失败次数设为5次
- 超过最大失败次数后程序优雅退出

#### 问题2：单次循环错误导致程序退出

**修复内容**：
- 在主循环内部添加try-except
- 单次循环内的错误只记录日志，不会导致程序退出
- 程序会继续运行下一次循环

---

## 修改的文件列表

| 文件路径 | 修改内容 |
|---------|---------|
| python_client/database.py | 修复SQL执行和重连逻辑 |
| python_client/opcua_client.py | 改进连接错误处理 |
| python_client/main.py | 添加重连失败限制，防止无限循环 |

---

## 验证方法

### 1. 测试连接

运行以下命令测试OPC UA和数据库连接：

```bash
cd python_client
python main.py --test-connection
```

### 2. 检查日志

查看日志文件了解详细错误信息：

```bash
type logs\data_collector.log
```

### 3. 正常运行

启动数据采集程序：

```bash
cd python_client
python main.py
```

---

## 配置检查

如果问题仍然存在，请检查以下配置：

### 数据库配置 (.env文件)

```ini
DB_TYPE=sqlite          # 或 mysql
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=energy_management
```

### OPC UA配置 (.env文件)

```ini
OPC_UA_SERVER_URL=opc.tcp://localhost:4840
OPC_UA_TIMEOUT=3
OPC_UA_RETRY_MAX=5
OPC_UA_RETRY_DELAY=5
```

---

## 常见问题

### Q1: 数据库连接失败

**可能原因**：
- 数据库服务未启动
- 连接配置错误
- 防火墙阻止连接

**解决方案**：
1. 确认数据库服务已启动
2. 检查.env文件中的数据库配置
3. 使用SQLite进行本地测试

### Q2: OPC UA连接失败

**可能原因**：
- KepServer未启动
- OPC UA服务器地址错误
- 防火墙阻止4840端口

**解决方案**：
1. 确认KepServer已启动并运行
2. 检查OPC UA服务器地址配置
3. 确保防火墙允许4840端口

### Q3: 程序仍然循环

**可能原因**：
- 配置文件未更新
- 旧进程仍在运行

**解决方案**：
1. 停止所有运行中的进程
2. 确认代码已更新
3. 重新启动程序

---

## 技术支持

如遇到其他问题，请：

1. 查看日志文件 `logs/data_collector.log`
2. 检查本文档的常见问题部分
3. 查阅项目README.md

---

**文档版本**：1.0  
**最后更新**：2025-12-11
